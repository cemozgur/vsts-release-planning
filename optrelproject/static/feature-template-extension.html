<!DOCTYPE html>
<html lang="en">

<head>
  <script src="scripts/jquery.min.js"></script>
  <script src="scripts/jquery.validate.min.js"></script>
  <script src="scripts/VSS.SDK.min.js"></script>
  <link href="css/fabric.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/fabric.components.min.css" />
  <link rel="stylesheet" href="css/main.css" />
    <meta charset="UTF-8">
    <title>Release Planning Optimal Template</title>
</head>

<body style="overflow:auto;">
    <script>
        var workItemID;
        var RPDSDocsExist = false;
        var RPDSDocsName = "RPDS";

        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true
        });

        VSS.require(["TFS/WorkItemTracking/Services"], function (_WorkItemServices) {

            // Get the WorkItemFormService.  This service allows you to get/set fields/links on the 'active' work item (the work item
            // that currently is displayed in the UI).
            function getWorkItemFormService()
            {
                return _WorkItemServices.WorkItemFormService.getService();
            }

            // Register a listener for the work item group contribution.
            VSS.register(VSS.getContribution().id, function () {
                return {
                    // Called when the active work item is modified
                    onFieldChanged: function(args) {
                        $(".events").append($("<div/>").text("onFieldChanged - " + JSON.stringify(args)));
                    },

                    // Called when a new work item is being loaded in the UI
                    /***
                     *  TODO: ytalo focus on this onLoaded
                     *
                     *
                     *
                     *
                     *
                     * */
                    onLoaded: function (args) {

                        getWorkItemFormService().then(function(service) {
                            // Get the current values for a few of the common fields
                            service.getFieldValue("System.Id").then(
                                function (value) {
                                    workItemID = value;
                                    console.log("Value:"+workItemID);
                                    $(".events").append($("<div/>").text("onLoaded - " + JSON.stringify(value)));
                                });

                                // Get data service
                                VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                                    // Get document by Work Item id
                                    console.log(workItemID);
                                    var id = 0;
                                    dataService.getDocument(RPDSDocsName, workItemID).then(function(doc) {
                                      id = doc.id;
                                    }).then(function(doc){
                                      console.log("ID is defined?: "+(id!=undefined))
                                      if(id!=undefined){
                                        RPDSDocsExist = true;
                                        document.getElementById('minBusinessValue').value = doc.BusinessValue.Min;
                                          document.getElementById('expectedBusinessValue').value = doc.BusinessValue.Expected;
                                            document.getElementById('maxBusinessValue').value = doc.BusinessValue.Max;
                                        document.getElementById('minCost').value = doc.Cost.Min;
                                          document.getElementById('expectedCost').value = doc.Cost.Expected;
                                            document.getElementById('maxCost').value = doc.Cost.Max;
                                        document.getElementById('minEffort').value = doc.Effort.Min;
                                          document.getElementById('expectedEffort').value = doc.Effort.Expected;
                                            document.getElementById('maxEffort').value = doc.Effort.Max;
                                        document.getElementById('minRisk').value = doc.Risk.Min;
                                          document.getElementById('expectedRisk').value = doc.Risk.Expected;
                                            document.getElementById('maxRisk').value = doc.Risk.Max;
                                        document.getElementById('minTimeCriticality').value = doc.timeCriticality.Min;
                                          document.getElementById('expectedTimeCriticality').value = doc.timeCriticality.Expected;
                                            document.getElementById('maxTimeCriticality').value = doc.timeCriticality.Max;
                                        document.getElementById('featureDependency').value = doc.Dependency;
                                      }
                                      console.log("RPDS: Doc exists = "+RPDSDocsExist);
                                    });
                                });

                        })




                    },

                    // Called when the active work item is being unloaded in the UI
                    onUnloaded: function (args) {
                        $(".events").empty();
                        $(".events").append($("<div/>").text("onUnloaded - " + JSON.stringify(args)));
                    },

                    // Called after the work item has been saved
                    onSaved: function (args) {
                        $(".events").append($("<div/>").text("onSaved - " + JSON.stringify(args)));
                        getWorkItemFormService().then(function(service) {
                            //service.setFieldValue("System.Title", "Title set from your group extension!");
                          console.log("Business Value: "+document.getElementById('minBusinessValue').value+","+document.getElementById('expectedBusinessValue').value+","+document.getElementById('maxBusinessValue').value);
                          console.log("Cost: "+document.getElementById('minCost').value+","+document.getElementById('expectedCost').value+","+document.getElementById('maxCost').value);
                          console.log("Effort: "+document.getElementById('minEffort').value+","+document.getElementById('expectedEffort').value+","+document.getElementById('maxEffort').value);
                          console.log("Risk: "+document.getElementById('minRisk').value+","+document.getElementById('expectedRisk').value+","+document.getElementById('maxRisk').value);
                          console.log("Time Criticality: "+document.getElementById('minTimeCriticality').value+","+document.getElementById('expectedTimeCriticality').value+","+document.getElementById('maxTimeCriticality').value);
                        });
                    },

                    // Called when the work item is reset to its unmodified state (undo)
                    onReset: function (args) {
                        $(".events").append($("<div/>").text("onReset - " + JSON.stringify(args)));
                    },

                    // Called when the work item has been refreshed from the server
                    onRefreshed: function (args) {
                        $(".events").append($("<div/>").text("onRefreshed - " + JSON.stringify(args)));
                    }
                }
            });

            VSS.notifyLoadSucceeded();

          // register a handler for the 'Click me!' button.
            $("#clickme").click(function() {


              VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                  // Get document by Work Item id

                  dataService.getDocument(RPDSDocsName, "Test").then(function(doc) {
                    id = doc.id;
                  }).then(function(doc){
                    console.log("ID is defined?: "+(id!=undefined))
                    if(id!=undefined){
                      RPDSDocsExist = true;
                      console.log("Value" + doc.value);
                    }
                    console.log("RPDS: Doc exists = "+RPDSDocsExist);
                  });
              });



              VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
              var newDoc = {
                id: "Test",
                value: 556421,
                valueB : "Test Value"
              };

              dataService.createDocument(RPDSDocsName, newDoc).then(function(doc) {
                  // Even if no ID was passed to createDocument, one will be generated
                  console.log("RPDS: Created Doc ID =" + doc.id);
              });



            });

            });

            // Get work item form service

            $.validator.addMethod("regex", function(value, element, regexpr) {
              return regexpr.test(value);
            });

            $("#saveSetting").submit(function(e) {
              e.preventDefault();
            }).validate({
              errorElement : 'div',
              errorLabelContainer: '#errors',
              rules: {
                // The key name on the left side is the name attribute
                // of an input field. Validation rules are defined
                // on the right side
                minBusinessValue : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                expectedBusinessValue : {
                  required: true,
                  number : true,
                  range : function() { return [ $('#minBusinessValue').val(), $('#maxBusinessValue').val() ]; },
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                maxBusinessValue : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                minCost : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                expectedCost : {
                  required: true,
                  number : true,
                  range : function() { return [ $('#minCost').val(), $('#maxCost').val() ]; },
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                maxCost : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                minEffort : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                expectedEffort : {
                  required: true,
                  number : true,
                  range : function() { return [ $('#minEffort').val(), $('#maxEffort').val() ]; },
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                maxEffort : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                minRisk : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                expectedRisk : {
                  required: true,
                  number : true,
                  range : function() { return [ $('#minRisk').val(), $('#maxRisk').val() ]; },
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                maxRisk : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                minTimeCriticality : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                expectedTimeCriticality : {
                  required: true,
                  number : true,
                  range : function() { return [ $('#minTimeCriticality').val(), $('#maxTimeCriticality').val() ]; },
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                maxTimeCriticality : {
                  required: true,
                  number : true,
                  regex : /^\d+(?:\.\d\d?)?$/
                },
                featureDependency : {
                  regex: /^[0-9,]+$/,
                  required: true,
                }
              },
              // Specify validation error messages
              messages: {
                minBusinessValue : {
                  required: "- Please enter minimum Business Value </br>",
                  number: "- Invalid minimum Business Value value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                expectedBusinessValue : {
                  required: "- Please enter expected Business Value </br>",
                  number: "- Invalid expected Business Value value (Number only)</br>",
                  range : "- Invalid Range; Expected Value must be within Minimum and Maximum Range, Maximum Value must more than or equal than Expected Value and/or Minimum Value must less or equal than Expected Value </br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                maxBusinessValue : {
                  required: "- Please enter maximum Business Value </br>",
                  number: "- Invalid maximum Business Value value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                minCost : {
                  required: "- Please enter minimum Implementation Cost </br>",
                  number: "- Invalid minimum Implementation Cost value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                expectedCost : {
                  required: "- Please enter expected Implementation Cost </br>",
                  number: "- Invalid expected Implementation Cost value (Number only)</br>",
                  range : "- Invalid Range; Expected Value must be within Minimum and Maximum Range, Maximum Value must more than or equal than Expected Value and/or Minimum Value must less or equal than Expected Value </br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                maxCost : {
                  required: "- Please enter maximum Implementation Cost </br>",
                  number: "- Invalid maximum Implementation Cost value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                minEffort : {
                  required: "- Please enter minimum Effort </br>",
                  number: "- Invalid minimum Effort value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                expectedEffort : {
                  required: "- Please enter expected Effort </br>",
                  number: "- Invalid expected Effort value (Number only)</br>",
                  range : "- Invalid Range; Expected Value must be within Minimum and Maximum Range, Maximum Value must more than or equal than Expected Value and/or Minimum Value must less or equal than Expected Value </br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                maxEffort : {
                  required: "- Please enter maximum Effort </br>",
                  number: "- Invalid maximum Effort value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                minRisk : {
                  required: "- Please enter minimum Risk </br>",
                  number: "- Invalid minimum Risk value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                expectedRisk : {
                  required: "- Please enter expected Risk </br>",
                  number: "- Invalid expected Risk value (Number only)</br>",
                  range : "- Invalid Range; Expected Value must be within Minimum and Maximum Range, Maximum Value must more than or equal than Expected Value and/or Minimum Value must less or equal than Expected Value </br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                maxRisk : {
                  required: "- Please enter maximum Risk </br>",
                  number: "- Invalid maximum Risk value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                minTimeCriticality : {
                  required: "- Please enter minimum Time Criticality </br>",
                  number: "- Invalid minimum Time Criticality value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                expectedTimeCriticality : {
                  required: "- Please enter expected Time Criticality </br>",
                  number: "- Invalid expected Time Criticality value (Number only)</br>",
                  range : "- Invalid Range; Expected Value must be within Minimum and Maximum Range, Maximum Value must more than or equal than Expected Value and/or Minimum Value must less or equal than Expected Value </br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                maxTimeCriticality : {
                  required: "- Please enter maximum Time Criticality </br>",
                  number: "- Invalid maximum Time Criticality value (Number only)</br>",
                  regex: "- Invalid Number Range (Postive Number Only)"
                },
                featureDependency : {
                  required: "- Please enter Feature Dependency/Dependencies</br>",
                  regex: "- Invalid Feature Dependency/Dependencies value (Number with comma separator only)</br>"

                }
              },
              submitHandler : function(form){
                // Get data service
                VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {

                    if(RPDSDocsExist == true){
                      console.log("RPDS: Document exists. Update the existing one.");
                          // Get document first
                          dataService.getDocument(RPDSDocsName, workItemID).then(function(doc) {
                              // Update the document
                              doc.BusinessValue.Min = document.getElementById('minBusinessValue').value;
                              doc.BusinessValue.Expected = document.getElementById('expectedBusinessValue').value;
                              doc.BusinessValue.Max = document.getElementById('maxBusinessValue').value;
                              doc.Cost.Min = document.getElementById('minCost').value;
                              doc.Cost.Expected = document.getElementById('expectedCost').value;
                              doc.Cost.Max = document.getElementById('maxCost').value;
                              doc.Effort.Min = document.getElementById('minEffort').value;
                              doc.Effort.Expected = document.getElementById('expectedEffort').value;
                              doc.Effort.Max = document.getElementById('maxEffort').value;
                              doc.Risk.Min = document.getElementById('minRisk').value;
                              doc.Risk.Expected = document.getElementById('expectedRisk').value;
                              doc.Risk.Max = document.getElementById('maxRisk').value;
                              doc.timeCriticality.Min = document.getElementById('minTimeCriticality').value;
                              doc.timeCriticality.Expected = document.getElementById('expectedTimeCriticality').value;
                              doc.timeCriticality.Max = document.getElementById('maxTimeCriticality').value;
                              doc.Dependency = document.getElementById('featureDependency').value;
                              dataService.updateDocument(RPDSDocsName, doc).then(function(d) {
                                  // Check the new version
                                  console.log("Doc version: " + d.__etag);
                              });
                          });

                    }else{
                      console.log("RPDS: Document is not exist. Create a new one.");
                      // Prepare document first
                      var newDoc = {
                        id: workItemID,
                        BusinessValue: {
                          Min : document.getElementById('minBusinessValue').value,
                          Expected :  document.getElementById('expectedBusinessValue').value,
                          Max : document.getElementById('maxBusinessValue').value
                        },
                        Cost: {
                          Min : document.getElementById('minCost').value,
                          Expected :  document.getElementById('expectedCost').value,
                          Max : document.getElementById('maxCost').value
                        },
                        Effort: {
                          Min : document.getElementById('minEffort').value,
                          Expected :  document.getElementById('expectedEffort').value,
                          Max : document.getElementById('maxEffort').value
                        },
                        Risk: {
                          Min : document.getElementById('minRisk').value,
                          Expected : document.getElementById('expectedRisk').value,
                          Max : document.getElementById('maxRisk').value
                        },
                        timeCriticality:{
                          Min : document.getElementById('minTimeCriticality').value,
                          Expected :  document.getElementById('expectedTimeCriticality').value,
                          Max : document.getElementById('maxTimeCriticality').value
                        },
                        Dependency: document.getElementById('featureDependency').value
                      };

                      dataService.createDocument(RPDSDocsName, newDoc).then(function(doc) {
                          // Even if no ID was passed to createDocument, one will be generated
                          console.log("RPDS: Created Doc ID =" + doc.id);
                      });

                       RPDSDocsExist = true;

                    }

                     alert("VSTS Release Planning Extenion: The feature configuration has been saved."); });
                  }
              });

            $("#clearSetting").click(function() {
              // Get work item form service
              // Get data service
               VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                   dataService.deleteDocument(RPDSDocsName, workItemID).then(function() {
                       console.log("RPDS: Doc deleted");
                   });

                   RPDSDocsExist = false;



               });
               document.getElementById('saveSetting').reset();

               alert("VSTS Release Planning Extenion: The feature configuration has been cleared.");
            });

            VSS.resize();

        });



    </script>


    <div class="ms-Grid-col msu-sm2 action-box ms-font-l ms-fontColor-error ms-borderColor-error ms-bgColor-error" id="errors"></div>

    <form action="" id="saveSetting">

      <div class="ms-Grid-col ms-u-sm12 block">

      <p class="ms-font-m ms-fontWeight-semibold">Business Value (How much this feature value in currency?): </p>

          <label class="ms-Label">Minimum Value: </label>
          <input class="ms-TextField-field" type="text" id="minBusinessValue" name="minBusinessValue" autocomplete="off" maxlength="255" aria-invalid="true">

          <label class="ms-Label">Expected Value: </label>
          <input  class="ms-TextField-field" type="text" id="expectedBusinessValue"  name="expectedBusinessValue" autocomplete="off" maxlength="255" aria-invalid="true">

          <label class="ms-Label">Maximum Value: </label>
          <input class="ms-TextField-field" type="text" id="maxBusinessValue" name="maxBusinessValue" autocomplete="off" maxlength="255" aria-invalid="true">



        <p class="ms-font-m ms-fontWeight-semibold">Implementation Cost (How much does it cost, in currency, to implement this feature?): </p>


        <label class="ms-Label">Minimum Value: </label>
        <input class="ms-TextField-field" type="text" id="minCost" name="minCost" autocomplete="off" maxlength="255" aria-invalid="true">

        <label class="ms-Label">Expected Value: </label>
        <input class="ms-TextField-field" type="text" id="expectedCost"  name="expectedCost" autocomplete="off" maxlength="255" aria-invalid="true">

        <label class="ms-Label">Maximum Value: </label>
        <input class="ms-TextField-field" type="text" id="maxCost" name="maxCost" autocomplete="off" maxlength="255" aria-invalid="true">




        <p class="ms-font-m ms-fontWeight-semibold">Effort (How many hours does it takes weekly to implement this feature?): </p>

        <label class="ms-Label">Minimum Value: </label>
        <input class="ms-TextField-field" type="text"  id="minEffort" name="minEffort" autocomplete="off" maxlength="255" aria-invalid="true">

        <label class="ms-Label">Expected Value: </label>
        <input class="ms-TextField-field" type="text"  id="expectedEffort"  name="expectedEffort" autocomplete="off" maxlength="255" aria-invalid="true">

        <label class="ms-Label">Maximum Value: </label>
        <input class="ms-TextField-field" type="text"  id="maxEffort" name="maxEffort" autocomplete="off" maxlength="255" aria-invalid="true">

        <p class="ms-font-m ms-fontWeight-semibold">Risk (What are the risk esitmation for developing this feature?): </p>

        <label class="ms-Label">Minimum Value: </label>

        <select class="form-select" id="minRisk" name="minRisk">
          <option value="1">Very Low</option>
          <option value="2">Low</option>
          <option value="3">Medium</option>
          <option value="4">High</option>
          <option value="5">Very High</option>
        </select>

        <label class="ms-Label">Expected Value: </label>

          <select class="form-select" id="expectedRisk"  name="expectedRisk">
          <option value="1">Very Low</option>
          <option value="2">Low</option>
          <option value="3">Medium</option>
          <option value="4">High</option>
          <option value="5">Very High</option>
        </select>

        <label class="ms-Label">Maximum Value: </label>

          <select class="form-select" id="maxRisk" name="maxRisk">
          <option value="1">Very Low</option>
          <option value="2">Low</option>
          <option value="3">Medium</option>
          <option value="4">High</option>
          <option value="5">Very High</option>
        </select>

        <p class="ms-font-m ms-fontWeight-semibold">Time Criticality (How importance (in percentage) of this feature to develop within the given deadline?): </p>

          <label class="ms-Label">Minimum Value: </label>
          <select class="form-select" id="minTimeCriticality" name="minTimeCriticality">
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Medium</option>
            <option value="4">High</option>
            <option value="5">Very High</option>
          </select>

          <label class="ms-Label">Expected Value: </label>
          <select class="form-select" id="expectedTimeCriticality" name="expectedTimeCriticality">
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Medium</option>
            <option value="4">High</option>
            <option value="5">Very High</option>
          </select>

          <label class="ms-Label">Maximum Value: </label>
          <select class="form-select" id="maxTimeCriticality" name="maxTimeCriticality">
            <option value="1">Very Low</option>
            <option value="2">Low</option>
            <option value="3">Medium</option>
            <option value="4">High</option>
            <option value="5">Very High</option>
          </select>

        <p class="ms-font-m ms-fontWeight-semibold">Dependency (Which Feature(s) required to develop before this, "0" for No Dependency): </p>

          <input class="ms-TextField-field" type="text" style="width:100%" id="featureDependency" name="featureDependency" autocomplete="off" maxlength="255" aria-invalid="true">

      <div style="padding-top:10px" >
      <button class="ms-Button ms-Button--primary" type="submit">
        <span class="ms-Button-label">Save Setting</span>
      </button>
      <button class="ms-Button" type="button" id="clearSetting">Clear Setting</button>
      </div>

    </div>


    <!--<button type="button" id="clickme">Click Me</button>-->

    </form>

</body>

</html>
