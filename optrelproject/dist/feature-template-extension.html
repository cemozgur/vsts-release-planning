<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Release Planning Optimal Template</title>
</head>

<body style="overflow:auto;">
    <script src="scripts/VSS.SDK.min.js"></script>
    <script>
        var workItemID;
        var RPDSDocsExist = false;
        var RPDSDocsName = "RPDS";

        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true
        });

        VSS.require(["TFS/WorkItemTracking/Services"], function (_WorkItemServices) {

            // Get the WorkItemFormService.  This service allows you to get/set fields/links on the 'active' work item (the work item
            // that currently is displayed in the UI).
            function getWorkItemFormService()
            {
                return _WorkItemServices.WorkItemFormService.getService();
            }

            // Register a listener for the work item group contribution.
            VSS.register(VSS.getContribution().id, function () {
                return {
                    // Called when the active work item is modified
                    onFieldChanged: function(args) {
                        $(".events").append($("<div/>").text("onFieldChanged - " + JSON.stringify(args)));
                    },

                    // Called when a new work item is being loaded in the UI
                    /***
                     *  TODO: ytalo focus on this onLoaded
                     *
                     *
                     *
                     *
                     *
                     * */
                    onLoaded: function (args) {

                        getWorkItemFormService().then(function(service) {
                            // Get the current values for a few of the common fields
                            service.getFieldValue("System.Id").then(
                                function (value) {
                                    workItemID = value;
                                    console.log("Value:"+workItemID);
                                    $(".events").append($("<div/>").text("onLoaded - " + JSON.stringify(value)));
                                });

                                // Get data service
                                VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                                    // Get document by Work Item id
                                    console.log(workItemID);
                                    var id = 0;
                                    dataService.getDocument(RPDSDocsName, workItemID).then(function(doc) {
                                      id = doc.id;
                                    }).then(function(doc){
                                      console.log("ID is defined?: "+(id!=undefined))
                                      if(id!=undefined){
                                        RPDSDocsExist = true;
                                        document.getElementById('businessValue').value = doc.BusinessValue;
                                        document.getElementById('cost').value = doc.Cost;
                                        document.getElementById('effort').value = doc.Effort;
                                        document.getElementById('minRisk').value = doc.Risk.Min;
                                        document.getElementById('expectedRisk').value = doc.Risk.Expected;
                                        document.getElementById('maxRisk').value = doc.Risk.Max;
                                        document.getElementById('timeCriticality').value = doc.timeCriticality;
                                        document.getElementById('featureDependency').value = doc.Dependency;
                                      }
                                      console.log("RPDS: Doc exists = "+RPDSDocsExist);
                                    });
                                });

                        })




                    },

                    // Called when the active work item is being unloaded in the UI
                    onUnloaded: function (args) {
                        $(".events").empty();
                        $(".events").append($("<div/>").text("onUnloaded - " + JSON.stringify(args)));
                    },

                    // Called after the work item has been saved
                    onSaved: function (args) {
                        $(".events").append($("<div/>").text("onSaved - " + JSON.stringify(args)));
                        getWorkItemFormService().then(function(service) {
                            //service.setFieldValue("System.Title", "Title set from your group extension!");
                          console.log("Business Value: "+document.getElementById('businessValue').value);
                          console.log("Cost: "+document.getElementById('cost').value);
                          console.log("Effort: "+document.getElementById('effort').value);
                          console.log("Risk: "+document.getElementById('minRisk').value+","+document.getElementById('expectedRisk').value+","+document.getElementById('maxRisk').value);
                          console.log("Time Criticality: "+document.getElementById('timeCriticality').value);
                        });
                    },

                    // Called when the work item is reset to its unmodified state (undo)
                    onReset: function (args) {
                        $(".events").append($("<div/>").text("onReset - " + JSON.stringify(args)));
                    },

                    // Called when the work item has been refreshed from the server
                    onRefreshed: function (args) {
                        $(".events").append($("<div/>").text("onRefreshed - " + JSON.stringify(args)));
                    }
                }
            });

            VSS.notifyLoadSucceeded();

          // register a handler for the 'Click me!' button.
            $("#clickme").click(function() {








            });

            // Get work item form service



            $("#saveSetting").click(function() {
              // Get data service
              VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {

                  if(RPDSDocsExist == true){
                    console.log("RPDS: Document exists. Update the existing one.");
                        // Get document first
                        dataService.getDocument(RPDSDocsName, workItemID).then(function(doc) {
                            // Update the document
                            doc.BusinessValue = document.getElementById('businessValue').value;
                            doc.Cost = document.getElementById('cost').value;
                            doc.Effort = document.getElementById('effort').value;
                            doc.Risk.Min = document.getElementById('minRisk').value;
                            doc.Risk.Expected = document.getElementById('expectedRisk').value;
                            doc.Risk.Max = document.getElementById('maxRisk').value;
                            doc.timeCriticality = document.getElementById('timeCriticality').value;
                            doc.Dependency = document.getElementById('featureDependency').value;
                            dataService.updateDocument(RPDSDocsName, doc).then(function(d) {
                                // Check the new version
                                console.log("Doc version: " + d.__etag);
                            });
                        });

                  }else{
                    console.log("RPDS: Document is not exist. Create a new one.");
                    // Prepare document first
                    var newDoc = {
                      id: workItemID,
                      BusinessValue: document.getElementById('businessValue').value,
                      Cost: document.getElementById('cost').value,
                      Effort: document.getElementById('effort').value,
                      Risk: {
                        Min : document.getElementById('minRisk').value,
                        Expected : document.getElementById('expectedRisk').value,
                        Max : document.getElementById('maxRisk').value
                      },
                      timeCriticality: document.getElementById('timeCriticality').value,
                      Dependency: document.getElementById('featureDependency').value
                    };

                    dataService.createDocument(RPDSDocsName, newDoc).then(function(doc) {
                        // Even if no ID was passed to createDocument, one will be generated
                        console.log("RPDS: Created Doc ID =" + doc.id);
                    });

                     RPDSDocsExist = true;

                  }

                  alert("Save Successfully");

              });

            });

            $("#clearSetting").click(function() {
              // Get work item form service
              // Get data service
               VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                   dataService.deleteDocument(RPDSDocsName, workItemID).then(function() {
                       console.log("RPDS: Doc deleted");
                   });

                   RPDSDocsExist = false;

                   alert("Setting has been cleared");

               });
            });

        });



    </script>

    <div id="settingValue-combo-container"/>
    <div id="documentValue-combo-container"/>

    <div class="control">
      <div class="workitemlabel label-control">
        <label class="workitemcontrol-label">Business Value: (Min,Expected,Max)</label>
      </div>
      <div class="workitemcontrol work-item-control initialized">
        <div class="combo input-text-box list text emptyBorder">
          <div class="wrap">
            <input type="text" id="businessValue" autocomplete="off" maxlength="255" aria-invalid="true">
          </div>
      </div>
    </div>

    <div class="control" style="padding-top: 3px">
      <div class="workitemlabel label-control">
        <label class="workitemcontrol-label">Implementation Cost: (Min,Expected,Max)</label>
      </div>
      <div class="workitemcontrol work-item-control initialized">
        <div class="combo input-text-box list text emptyBorder">
          <div class="wrap">
        <input type="text" id="cost" autocomplete="off" maxlength="255" aria-invalid="true">
        </div>
      </div>
    </div>

    <div class="control" style="padding-top: 3px">
      <div class="workitemlabel label-control">
        <label class="workitemcontrol-label">Effort (Hrs/Week): (Min,Expected,Max)</label>
      </div>
      <div class="workitemcontrol work-item-control initialized">
        <div class="combo input-text-box list text emptyBorder">
          <div class="wrap">
        <input type="text" id="effort" autocomplete="off" maxlength="255" aria-invalid="true">
      </div>
      </div>
    </div>

    <div class="control" style="padding-top: 3px">
      <div class="workitemlabel label-control">
        <label class="workitemcontrol-label">Risk: (Min,Expected,Max)</label>
      </div>
      <div class="workitemcontrol work-item-control initialized">

        <div class="wrap">
        <select id="minRisk">
        <option value="1">Very Low</option>
        <option value="2">Low</option>
        <option value="3">Medium</option>
        <option value="4">High</option>
        <option value="5">Very High</option>
        </select>
        <select id="expectedRisk">
        <option value="1">Very Low</option>
        <option value="2">Low</option>
        <option value="3">Medium</option>
        <option value="4">High</option>
        <option value="5">Very High</option>
        </select>
        <select id="maxRisk">
        <option value="1">Very Low</option>
        <option value="2">Low</option>
        <option value="3">Medium</option>
        <option value="4">High</option>
        <option value="5">Very High</option>
        </select>
      </div>
    </div>

    <div class="control" style="padding-top: 3px">
      <div class="workitemlabel label-control">
        <label class="workitemcontrol-label">Time Criticality: (Min,Expected,Max)</label>
      </div>
      <div class="workitemcontrol work-item-control initialized">
        <div class="combo input-text-box list text emptyBorder">
          <div class="wrap">
          <input type="text" id="timeCriticality" autocomplete="off" maxlength="255" aria-invalid="true">
      </div>
      </div>
    </div>

    <div class="control" style="padding-top: 3px">
      <div class="workitemlabel label-control">
        <label class="workitemcontrol-label">Dependency (Sequence of Feature Numbers): </label>
      </div>
      <div class="workitemcontrol work-item-control initialized">
        <div class="combo input-text-box list text emptyBorder">
          <div class="wrap">
          <input type="text" id="featureDependency" autocomplete="off" maxlength="255" aria-invalid="true">
      </div>
      </div>
    </div>

    <button type="button" id="saveSetting">Save Setting</button><br/>
    <button type="button" id="clearSetting">Clear Setting</button><br/>

</body>

</html>
